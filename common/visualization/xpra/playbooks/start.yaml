- name: Start Xpra
  hosts: all
  strategy: free
  tasks:
    - name: Create password file
      copy:
        content: "{{ RAND_PASS }}"
        dest: "{{ansible_env.HOME}}/password.txt"
    - name: Get xpra certificate
      copy:
        src: /etc/xpra/ssl-cert.pem
        dest: "{{ansible_env.HOME}}/ssl-cert-xpra.pem"
        owner: "{{ ansible_env.USER }}"
        remote_src: yes
      become: yes
      become_method: sudo
    - name: Start Xpra
      command: "xpra start --bind-wss=0.0.0.0:{{ PORT }} --exit-with-children --start-child=\"paraview\" --html=on --pidfile=/tmp/xprapid --wss-auth=file:filename={{ansible_env.HOME}}/password.txt --ssl-cert {{ansible_env.HOME}}/ssl-cert-xpra.pem"
    - name: Expose endpoint as operation output
      set_fact:
        ENDPOINT: "/index.html?password={{ RAND_PASS }}"
